<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="GitLab DevOps: Drupal Deployment" /><meta name="author" content="Ryan Robinson" /><meta property="og:locale" content="en" /><meta name="description" content="This continues where the previous post in the GitLab DevOps series left off. We can now deploy code changes to the new server, and that’s great for generic deployments. Drupal adds a few extra components when it comes to configuration sync and the database." /><meta property="og:description" content="This continues where the previous post in the GitLab DevOps series left off. We can now deploy code changes to the new server, and that’s great for generic deployments. Drupal adds a few extra components when it comes to configuration sync and the database." /><link rel="canonical" href="https://ryanrobinson.technology/websites/drupal/gitlab-devops/" /><meta property="og:url" content="https://ryanrobinson.technology/websites/drupal/gitlab-devops/" /><meta property="og:site_name" content="Ryan Robinson Technology" /><meta property="og:image" content="https://ryanrobinson.technology/assets/logo/GitLab.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-02T10:47:05-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://ryanrobinson.technology/assets/logo/GitLab.png" /><meta property="twitter:title" content="GitLab DevOps: Drupal Deployment" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Ryan Robinson" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ryan Robinson"},"dateModified":"2023-01-02T10:47:05-05:00","datePublished":"2023-01-02T10:47:05-05:00","description":"This continues where the previous post in the GitLab DevOps series left off. We can now deploy code changes to the new server, and that’s great for generic deployments. Drupal adds a few extra components when it comes to configuration sync and the database.","headline":"GitLab DevOps: Drupal Deployment","image":"https://ryanrobinson.technology/assets/logo/GitLab.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://ryanrobinson.technology/websites/drupal/gitlab-devops/"},"url":"https://ryanrobinson.technology/websites/drupal/gitlab-devops/"}</script><title>GitLab DevOps: Drupal Deployment | Ryan Robinson Technology</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ryan Robinson Technology"><meta name="application-name" content="Ryan Robinson Technology"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/Ryan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ryan Robinson Technology</a></div><div class="site-subtitle font-italic">Web technology, Microsoft 365, and more</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ryan-l-robinson" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://mstdn.ca/@Ryan" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/ryanlewisrobinson/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GitLab DevOps: Drupal Deployment</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GitLab DevOps: Drupal Deployment</h1><div class="post-meta text-muted"><div> By <em> <a href="https://www.linkedin.com/in/ryanlewisrobinson/">Ryan Robinson</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2023-01-02 10:47:05 -0500" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 2, 2023, 10:47 AM -0500" >Jan 2, 2023</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1842 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p>This continues where <a href="/websites/gitlab-devops-deploy/">the previous post</a> in <a href="/tags/gitlab-devops/">the GitLab DevOps series</a> left off. We can now deploy code changes to the new server, and that’s great for generic deployments. Drupal adds a few extra components when it comes to configuration sync and the database.</p><h2 id="dev-vs-production">Dev vs Production<a href="#dev-vs-production" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>The biggest challenge with this topic is navigating that there should be some things different from dev and staging servers compared to production. Some of these are cases where the module or core configuration is on each server, but with different options (e.g. <a href="https://drupal.org/project/environment_indicator">environment indicator</a>) and others are a case of modules that are only needed on dev and staging and therefore shouldn’t be on production at all (e.g. <a href="https://www.drupal.org/project/maillog">maillog</a> and <a href="https://www.drupal.org/project/stage_file_proxy">stage_file_proxy</a>).</p><p>Composer offers a good way to handle the code package building distinction. You can require a package, or require-dev a package. Then you can <code class="language-plaintext highlighter-rouge">composer install</code> or <code class="language-plaintext highlighter-rouge">composer install --no-dev</code> depending on the server. That part is straightforward.</p><p>The hard part is the distinctions in configuration. Much of this can be handled using the <a href="https://www.drupal.org/project/config_ignore">config_ignore</a> module, which tells the configuration imports and exports to not include that configuration file, which means it doesn’t get synced across the servers. You have to set those ignored configurations up separately on every server, which means if there’s a change, you need to remember to do it on all environments where it would be relevant. But then there’s other configurations like modules that shouldn’t be active at all on production but is on dev and staging. You can’t simply ignore syncing the installed modules configuration, or else you’d have a mess every time you added or removed a module. Sometimes those modules create new configuration schemas, or require you to change another configuration schema to take advantage of it.</p><p>Maillog is the best example of this. Maillog is a module that should install on dev/staging but not production, as it is a debugging tool for logging outgoing mail rather than sending it. It can be separated in composer as a dev module so that the code doesn’t install on production. But then it also changes the modules configuration when it is installed, as well as the site’s mail settings configuration. Ideally these servers are still managed through the configuration, with differences in dev/staging compared to production. That rules out using config_ignore.</p><p>The other imperfect option is changing those configurations as part of the CI/CD processes. It also has a couple of problems:</p><ol><li>There might be a few seconds where the configuration is wrong, e.g. if you import the synced configuration but then force it back to the desired value with a follow-up command. Often this doesn’t matter, like a module being installed and then being promptly uninstalled again, but in other cases like sending email, it might be that the site tries to send an email in those few seconds, fails, and nobody notices that somebody should have gotten an email but didn’t. So you’d have to be very careful about this technique in production.<li>It relies on keeping the CI/CD up to date. If something changes with the site configuration, you better remember to account for how that configuration will be the same or different on all servers and if the CI/CD needs any changes to prepare for it. This makes it more prone to something breaking when you forget or can’t adequately test production behaviour until it’s too late, already on production.</ol><p>Note: I did try the <a href="https://www.drupal.org/project/config_split">config_split</a> module, which sounds like it should help but did not work reliably. There is an update that came out since my last times, so maybe it will be worth trying it again.</p><p>For the simplicity of the rest of this blog post, I’ve decided not to include my specific examples here. Hopefully my thoughts on how I’ve negotiated the options for these kinds of scenarios is more valuable than any specific conclusions that we have in place right now.</p><h2 id="the-jobs">The Jobs<a href="#the-jobs" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>These jobs are added to the general function deploy.yml, which in my real-world scenario is in a different project but could be in the same project.</p><p>Here’s what the extendable jobs look like:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="c1">### Generic deploy to specified server ###</span>
<span class="na">.deploy_template</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">$ENVIRONMENT_NAME</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">$SERVER_URL</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">echo "Deploying to server at $SERVER_URL"</span>
    <span class="pi">-</span> <span class="s">cd $WEB_ROOT</span>
    <span class="pi">-</span> <span class="s">git fetch</span>
    <span class="pi">-</span> <span class="s">git reset --hard</span>
    <span class="pi">-</span> <span class="s">git stash</span>
    <span class="pi">-</span> <span class="s">git pull</span>

<span class="c1">### Drupal install jobs ###</span>
<span class="na">.drupal_composer</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">$ENVIRONMENT_NAME</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">$SERVER_URL</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd $WEB_ROOT</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush state:set system.maintenance_mode 1 --input-format=integer</span>
    <span class="pi">-</span> <span class="s">composer install</span>

<span class="na">.drupal_composer_prod</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">$ENVIRONMENT_NAME</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">$SERVER_URL</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd $WEB_ROOT</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush state:set system.maintenance_mode 1 --input-format=integer</span>
    <span class="pi">-</span> <span class="s">composer install --no-dev</span>

<span class="na">.drupal_config</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">$ENVIRONMENT_NAME</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">$SERVER_URL</span>
  <span class="na">after_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd $WEB_ROOT</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush state:set system.maintenance_mode 1 --input-format=integer</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush cr</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush config-import -y</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush cr</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush updb -y</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush state:set system.maintenance_mode 0 --input-format=integer</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush cr</span>

<span class="na">.drupal_cache</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">$ENVIRONMENT_NAME</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">$SERVER_URL</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod2</span>
  <span class="na">after_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd $WEB_ROOT</span>
    <span class="pi">-</span> <span class="s">vendor/drush/drush/drush cr</span>
</pre></table></code></div></div><p>The first job is the one detailed in <a href="/websites/gitlab-devops-deploy/">the previous post</a>, except that it has now been moved from <code class="language-plaintext highlighter-rouge">script</code> to <code class="language-plaintext highlighter-rouge">before-script</code> to work better with the other pieces.</p><p>The next component is composer. Drupal is built using composer packages. Any action that updates the composer.lock file - adding a new module, deleting a module, updating packages - will require this step. <code class="language-plaintext highlighter-rouge">composer install</code> ensures that it installs the exact same versions of the exact same packages as on your other servers. It might be tempting to use <code class="language-plaintext highlighter-rouge">composer update</code> instead to get the latest versions, but then you might end up with trying to install something that you haven’t tested elsewhere yet. There are two variants of this job, one for dev servers that installs dev packages and one for production that does not.</p><p>Secondly, the configuration and databases need to be updated. <code class="language-plaintext highlighter-rouge">drush cr</code> rebuilds your caches. There’s one to start this section because it is often necessary for scenarios like a new module. The Drupal cache needs to know when there’s a new module with the code in place, before you get to the <code class="language-plaintext highlighter-rouge">config-import</code> that will try to install that module. Otherwise you’ll get an error. With that settled, you can import all the configuration changes, then clear the caches again to ensure the site is now reflecting those changes. Finally, update the site’s database using <code class="language-plaintext highlighter-rouge">drush updb</code>. This is sometimes needed with new modules or updated modules that need to change the database schema. If you don’t do this, you can end up with errors about missing columns in tables.</p><p>The final job only clears the caches, without any of the other changes. The reason for these separations will become more clear in the site’s jobs that extend from these.</p><h2 id="site-jobs">Site Jobs<a href="#site-jobs" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>These are the jobs to execute each job on the relevant server, found in the .gitlab-ci.yml file for the project.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="c1">## Deploy Jobs ##</span>

<span class="c1">### Deploys to dev server only when changes are made to the dev branch ###</span>
<span class="na">deploy_dev</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">.deploy_template</span>
    <span class="pi">-</span> <span class="s">.drupal_composer</span>
    <span class="pi">-</span> <span class="s">.drupal_config</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Development</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">dev.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">dev</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">dev</span>

<span class="c1">### Deploys to staging server only when changes are made to the main branch ###</span>
<span class="na">deploy_staging</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.deploy_template</span>
    <span class="pi">-</span> <span class="s">.drupal_composer</span>
    <span class="pi">-</span> <span class="s">.drupal_config</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Staging</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">staging.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">staging</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>

<span class="c1">### Deploys code to production only when main branch and manually triggered ###</span>
<span class="na">deploy_prod_1</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">.deploy_template</span>
    <span class="pi">-</span> <span class="s">.drupal_composer</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Prod </span><span class="m">1</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">prod1.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod1</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>  
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>

<span class="na">deploy_prod_2</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">.deploy_template</span>
    <span class="pi">-</span> <span class="s">.drupal_composer</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Prod </span><span class="m">2</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">prod2.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod2</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>  
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>

<span class="c1">#### Deploys config updates to production. These need to wait for both servers to have the composer updated code. ####</span>
<span class="na">drupal_install_prod1</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.drupal_config</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Production </span><span class="m">1</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">prod1.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod1</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">deploy_prod1</span><span class="pi">,</span> <span class="nv">deploy_prod2</span><span class="pi">]</span>

<span class="na">drupal_install_prod2</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.drupal_cache</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT_NAME</span><span class="pi">:</span> <span class="s">Production </span><span class="m">2</span>
    <span class="na">SERVER_URL</span><span class="pi">:</span> <span class="s">prod2.demo.com</span>
    <span class="na">WEB_ROOT</span><span class="pi">:</span> <span class="s">/opt/www/html</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod2</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="na">refs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">deploy_prod1</span><span class="pi">,</span> <span class="nv">deploy_prod2</span><span class="pi">,</span> <span class="nv">drupal_install_prod1</span><span class="pi">]</span>
</pre></table></code></div></div><p>Deploying to dev server can be done in a single job. The before_script deploys the code changes, the script installs from composer, and the after_script imports the configuration. It runs on any change to the dev branch. The idea is that we do work on separate issue branches, then when we need to test on dev, we merge it into the dev branch and it will deploy there.</p><p>Deploying to staging server is the same, but with different variables for the server details and activating on merges to main instead of to dev. Merges to main should only happen when its a release candidate ready for final testing before deployment.</p><p>Deploying to production adds a couple more layers to consider. There are two servers load balanced, with one database on a different dedicated server. Composer needs to install the updates on both servers. But the configuration only needs to be imported on one, since it’s the same database - it wouldn’t break anything to do the config on both, but would be an unnecessary extra few minutes of the site being in maintenance mode to run the same job all over again. The second server does still need caches cleared, though, or it might take some time for the changes to be reflected there, which could mean errors in the meantime.</p><p>The other factor to consider is that the configuration import should not run until the code update has been deployed on both servers. If the order of operations was to install code updates on prod 1, then run config import, it would be trying to make updates on the shared database when only one of the servers has the code ready for the updates. That’s why production can’t collapse to one job per environment like dev and staging do.</p><p>The resulting order of operation that you need is:</p><ol><li>Deploy code changes, with composer install, to production 1.<li>Deploy code changes, with composer install, to production 2.<li>Import configuration changes to production 1.<li>Clear the caches on production 2.</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/websites/'>Websites</a>, <a href='/categories/drupal/'>Drupal</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/gitlab/" class="post-tag no-text-decoration" >GitLab</a> <a href="/tags/gitlab-devops/" class="post-tag no-text-decoration" >GitLab DevOps</a> <a href="/tags/php/" class="post-tag no-text-decoration" >PHP</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GitLab DevOps: Drupal Deployment - Ryan Robinson Technology&url=https://ryanrobinson.technology/websites/drupal/gitlab-devops/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GitLab DevOps: Drupal Deployment - Ryan Robinson Technology&u=https://ryanrobinson.technology/websites/drupal/gitlab-devops/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GitLab DevOps: Drupal Deployment - Ryan Robinson Technology&url=https://ryanrobinson.technology/websites/drupal/gitlab-devops/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ryanrobinson.technology/websites/drupal/gitlab-devops/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/websites/drupal/dev-env-updated/">Drupal Dev Environment Updated: The Dockerfiles</a><li><a href="/websites/drupal/open-menu/">Drupal: Open Menu</a><li><a href="/websites/vs-code/extensions-2024/">VS Code Extensions: My Workflows</a><li><a href="/websites/drupal/disable-pw-reset/">Drupal: Disable Password Reset</a><li><a href="/websites/brandwood-a11y/">Brandwood A11y Checker</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/visual-studio-code/">Visual Studio Code</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/gitlab/">GitLab</a> <a class="post-tag" href="/tags/accessibility/">Accessibility</a> <a class="post-tag" href="/tags/ms-101/">MS-101</a> <a class="post-tag" href="/tags/gitlab-devops/">GitLab DevOps</a> <a class="post-tag" href="/tags/ms-700/">MS-700</a> <a class="post-tag" href="/tags/drupal-docker/">Drupal Docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/websites/drupal/gitlab-devops-php-lint/"><div class="card-body"> <em class="timeago small" date="2022-02-05 08:51:00 -0500" >Feb 5, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GitLab DevOps: PHP Lint</h3><div class="text-muted small"><p> Here’s another piece in a GitLab DevOps setting: when code is committed to GitLab, I want to run a PHP linter on the custom code folders of Drupal (modules and themes) to make sure there aren’t any...</p></div></div></a></div><div class="card"> <a href="/websites/gitlab-devops-deploy/"><div class="card-body"> <em class="timeago small" date="2022-12-30 15:45:05 -0500" >Dec 30, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GitLab DevOps: Deploy to Server</h3><div class="text-muted small"><p> This continues with the long-stalled GitLab DevOps series. An essential piece of any CI/CD system is deploying to another server. You do not want to have to sign in to each server separately and ca...</p></div></div></a></div><div class="card"> <a href="/websites/vagrant-oracle-linux-vm/"><div class="card-body"> <em class="timeago small" date="2021-11-10 16:34:00 -0500" >Nov 10, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Vagrant: Oracle Linux VM</h3><div class="text-muted small"><p> This is the first in a series setting up a basic DevOps pipeline through local virtual machines, GitLab, a dev server, a staging server, and a production server. This first post will look at the lo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/websites/gitlab-devops-deploy/" class="btn btn-outline-primary" prompt="Older"><p>GitLab DevOps: Deploy to Server</p></a> <a href="/websites/gitlab-web-ide/" class="btn btn-outline-primary" prompt="Newer"><p>GitLab's New Web IDE</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://www.linkedin.com/in/ryanlewisrobinson/">Ryan Robinson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/visual-studio-code/">Visual Studio Code</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/gitlab/">GitLab</a> <a class="post-tag" href="/tags/accessibility/">Accessibility</a> <a class="post-tag" href="/tags/ms-101/">MS-101</a> <a class="post-tag" href="/tags/gitlab-devops/">GitLab DevOps</a> <a class="post-tag" href="/tags/ms-700/">MS-700</a> <a class="post-tag" href="/tags/drupal-docker/">Drupal Docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
