<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Drupal Dev Environment Updated: The Dockerfiles" /><meta name="author" content="Ryan Robinson" /><meta property="og:locale" content="en" /><meta name="description" content="A while ago I wrote about building a Docker Desktop dev environment for Drupal. It was built on Oracle Linux, a requirement in that context, with three images for Apache, PHP, and MySQL. But there were some significant problems with it, first and foremost that it was very slow. So, this is another version, now based on one of the official Drupal images instead of the Oracle Linux ones. It can be seen on my GitHub." /><meta property="og:description" content="A while ago I wrote about building a Docker Desktop dev environment for Drupal. It was built on Oracle Linux, a requirement in that context, with three images for Apache, PHP, and MySQL. But there were some significant problems with it, first and foremost that it was very slow. So, this is another version, now based on one of the official Drupal images instead of the Oracle Linux ones. It can be seen on my GitHub." /><link rel="canonical" href="https://ryanrobinson.technology/websites/drupal/dev-env-updated/" /><meta property="og:url" content="https://ryanrobinson.technology/websites/drupal/dev-env-updated/" /><meta property="og:site_name" content="Ryan Robinson Technology" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-24T20:16:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Drupal Dev Environment Updated: The Dockerfiles" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Ryan Robinson" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ryan Robinson"},"dateModified":"2024-04-08T10:52:17-04:00","datePublished":"2024-03-24T20:16:00-04:00","description":"A while ago I wrote about building a Docker Desktop dev environment for Drupal. It was built on Oracle Linux, a requirement in that context, with three images for Apache, PHP, and MySQL. But there were some significant problems with it, first and foremost that it was very slow. So, this is another version, now based on one of the official Drupal images instead of the Oracle Linux ones. It can be seen on my GitHub.","headline":"Drupal Dev Environment Updated: The Dockerfiles","mainEntityOfPage":{"@type":"WebPage","@id":"https://ryanrobinson.technology/websites/drupal/dev-env-updated/"},"url":"https://ryanrobinson.technology/websites/drupal/dev-env-updated/"}</script><title>Drupal Dev Environment Updated: The Dockerfiles | Ryan Robinson Technology</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ryan Robinson Technology"><meta name="application-name" content="Ryan Robinson Technology"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/Ryan.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ryan Robinson Technology</a></div><div class="site-subtitle font-italic">Web technology, Microsoft 365, and more</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ryan-l-robinson" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://mstdn.ca/@Ryan" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/ryanlewisrobinson/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Drupal Dev Environment Updated: The Dockerfiles</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E" data-src="/assets/img/logo/Drupal.png" class="preview-img bg" alt="Drupal logo" width="300" height="300" data-proofer-ignore><h1 data-toc-skip>Drupal Dev Environment Updated: The Dockerfiles</h1><div class="post-meta text-muted"><div> By <em> <a href="https://www.linkedin.com/in/ryanlewisrobinson/">Ryan Robinson</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2024-03-24 20:16:00 -0400" data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 24, 2024, 8:16 PM -0400" >Mar 24</em> </span> <span> Updated <em class="timeago" date="2024-04-08 10:52:17 -0400 " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 8, 2024, 10:52 AM -0400" >Apr 8</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1349 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>A while ago I wrote about building a <a href="/tags/drupal-docker/">Docker Desktop dev environment for Drupal</a>. It was built on Oracle Linux, a requirement in that context, with three images for Apache, PHP, and MySQL. But there were some significant problems with it, first and foremost that it was very slow. So, this is another version, now based on one of the official Drupal images instead of the Oracle Linux ones. <a href="https://github.com/ryan-l-robinson/Drupal-Devcontainer">It can be seen on my GitHub</a>.</p><h2 id="the-web-image">The Web Image<a href="#the-web-image" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>This new setup has both Apache and PHP in the same container, is about 40% of the total image size compared to the previous one, and runs much faster, probably because Apache and PHP are in the same container instead of having to communicate across the network. Let’s start with the basic start to the image and its shell.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> drupal:php8.2-apache</span>
<span class="k">USER</span><span class="s"> root</span>
<span class="k">SHELL</span><span class="s"> ["/bin/bash", "-c"]</span>
</pre></table></code></div></div><p>Install the extra useful packages - some of the most essential ones are already included in the Drupal image - and PHP development settings. The file copied from the PHP folder covers some of the XDebug configuration settings.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># Install needed repositories and general packages, and put the php.ini in place</span>
<span class="k">RUN </span>apt-get update <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> wget git zip which <span class="nb">sudo </span>vim locales default-mysql-client docker nodejs npm <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt-get upgrade <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mv</span> /usr/local/etc/php/php.ini-development /usr/local/etc/php/php.ini

<span class="c"># Install PHP extensions, using PECL</span>
<span class="k">RUN </span>pecl channel-update pecl.php.net <span class="se">\
</span>    <span class="o">&amp;&amp;</span> pecl <span class="nb">install </span>apcu xdebug uploadprogress <span class="se">\
</span>    <span class="o">&amp;&amp;</span> docker-php-ext-enable apcu <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"apc.enable_cli=1"</span> <span class="o">&gt;&gt;</span> /usr/local/etc/php/conf.d/docker-php-ext-apcu.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> docker-php-ext-enable xdebug <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">touch</span> /var/log/xdebug.log <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown </span>www-data:www-data /var/log/xdebug.log <span class="se">\
</span>    <span class="o">&amp;&amp;</span> docker-php-ext-enable uploadprogress
<span class="k">COPY</span><span class="s"> /php /usr/local/etc/php/conf.d</span>
</pre></table></code></div></div><p>Let the default www-data user have sudo permission without passwords, which would not be the way to go in production but in a development environment is pretty useful in case you ever need to do things like install a new package without rebuilding the whole environment.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># Add www-data user to sudo group, and allow those users to sudo without password</span>
<span class="k">RUN </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> <span class="nb">sudo </span>www-data <span class="se">\
</span>    <span class="o">&amp;&amp;</span> usermod <span class="nt">-d</span> /user/www-data www-data <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /user/www-data/.vscode-server <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown</span> <span class="nt">-R</span> www-data:www-data /user/www-data <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /user/www-data/.ssh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown</span> <span class="nt">-R</span> www-data:www-data /user/www-data/.ssh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>700 <span class="nt">-R</span> /user/www-data/.ssh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> ssh-keyscan <span class="nt">-t</span> rsa gitlab.com <span class="o">&gt;&gt;</span> /user/www-data/.ssh/known_hosts <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/%sudo	ALL=(ALL:ALL) ALL/%sudo	ALL=(ALL)	NOPASSWD: ALL/g"</span> /etc/sudoers
</pre></table></code></div></div><p>Fix a locale error that shows up once Apache is running, by specifying the locale it is running in. In my case, that’s Canada, with Canadian English.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># Fixes locale errors, must happen before Apache. This is using my locale of Canada</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"LC_ALL=en_CA.UTF-8"</span> <span class="o">&gt;&gt;</span> /etc/environment <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"en_CA.UTF-8 UTF-8"</span> <span class="o">&gt;&gt;</span> /etc/locale.gen <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"LANG=en_CA.UTF-8"</span> <span class="o">&gt;</span> /etc/locale.conf <span class="se">\
</span>    <span class="o">&amp;&amp;</span> locale-gen en_CA.UTF-8
</pre></table></code></div></div><p>Add a self-signed certificate for the Apache configuration, so that we’ll be able to browse the site locally with HTTPS.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Apache configuration, including SSL certificates and logs</span>
<span class="k">COPY</span><span class="s"> /apache /etc/apache2</span>
<span class="k">RUN </span>a2enmod ssl <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /etc/apache2/certs <span class="se">\
</span>    <span class="o">&amp;&amp;</span> openssl req <span class="nt">-batch</span> <span class="nt">-newkey</span> rsa:4096 <span class="nt">-nodes</span> <span class="nt">-sha256</span> <span class="nt">-keyout</span> /etc/apache2/certs/example.com.key <span class="nt">-x509</span> <span class="nt">-days</span> 3650 <span class="nt">-out</span> /etc/apache2/certs/example.com.crt <span class="nt">-config</span> /etc/apache2/certs/openssl-config.txt <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown</span> <span class="nt">-R</span> root:www-data /etc/apache2 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>770 <span class="nt">-R</span> /etc/apache2/certs
</pre></table></code></div></div><p>Increase some of the default resource limits for PHP. The defaults never seem to be nearly enough for Drupal. These go much larger, larger than you really need on production, but on local development it is easier to be safe than sorry.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Increase resources for PHP</span>
<span class="k">RUN </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/max_execution_time = 30/max_execution_time = 300/g"</span> /usr/local/etc/php/php.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/max_input_time = 60/max_input_time = 600/g"</span> /usr/local/etc/php/php.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/memory_limit = 128M/memory_limit = 2048M/g"</span> /usr/local/etc/php/php.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/upload_max_filesize = 2M/upload_max_filesize = 128M/g"</span> /usr/local/etc/php/php.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/post_max_size = 8M/post_max_size = 256M/g"</span> /usr/local/etc/php/php.ini <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/;max_input_vars = 1000/max_input_vars = 10000/g"</span> /usr/local/etc/php/php.ini
</pre></table></code></div></div><p>This is a minor thing, but I like when I grep through code to see results with the colour highlights, making it much easier to read. That can be done by setting an environment variable and putting an alias for grep into a bashrc file.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># Set up nicer grep results</span>
<span class="k">ENV</span><span class="s"> GREP_COLORS='mt=1;37;41'</span>
<span class="k">COPY</span><span class="s"> .bashrc /user/www-data/.bashrc</span>
</pre></table></code></div></div><p>Line up the script that will be run after creating the images. That script will handle setting up the Drupal database, but I’ll cover that more in the next post.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># Scripts for further actions to take on creation and attachment</span>
<span class="k">COPY</span><span class="s"> ./scripts/postCreateCommand.sh /postCreateCommand.sh</span>
</pre></table></code></div></div><p>Copy the Drupal settings file and the local services file. The former is the essential settings for any Drupal site, including being able to connect to the database. The latter is not essential but enables some of the development features that are ideal in local development, like seeing comments in the generated HTML code that shows you what template is being used to generate it.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># Drupal configuration</span>
<span class="k">COPY</span><span class="s"> /drupal /web/sites</span>
</pre></table></code></div></div><p>Finally, set the permissions on the main Drupal folder as well as on the script that we’ll need to be able to run.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">RUN </span><span class="nb">chown</span> <span class="nt">-R</span> www-data:www-data /opt/drupal <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chown </span>www-data:www-data /postCreateCommand.sh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>777 /postCreateCommand.sh
</pre></table></code></div></div><p>Much of this is the same as the previous version: adding a self-signed SSL certificate, increasing PHP resources. But a few things changed:</p><ul><li>Many of the PHP extensions are already installed from the Drupal image so I didn’t need to do them again in this Dockerfile.<li>It needs a lot more overriding the permissions since that Drupal image already comes with a Drupal install in that /opt/drupal directory and with the www-data user, and with some as volumes which mean they immediately revert to root ownership when you attach to it.</ul><h2 id="the-database-image">The Database Image<a href="#the-database-image" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Here’s the entire Dockerfile:</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># Use the default MariaDB image</span>
<span class="k">FROM</span><span class="s"> mariadb:latest</span>

<span class="k">ENV</span><span class="s"> MARIADB_ROOT_PASSWORD=drupalroot</span>
<span class="k">ENV</span><span class="s"> MARIADB_DATABASE=drupal</span>
<span class="k">ENV</span><span class="s"> MARIADB_USER=drupal</span>
<span class="k">ENV</span><span class="s"> MARIADB_PASSWORD=drupal</span>

<span class="c"># Expose the MySQL port to be accessible to the web container.</span>
<span class="k">EXPOSE</span><span class="s"> 3306</span>
</pre></table></code></div></div><p>This is essentially no change from the previous one, just setting the environment variables to define the database and its access.</p><h2 id="docker-compose">Docker Compose<a href="#docker-compose" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>The docker compose file is not doing anything too unusual. The main thing of note is the volumes. I do not have the entire /opt/drupal set up as volumes. That’s because when you attach to it, the entire area would get its permissions reassigned back to root, which causes issues. It’s also not very efficient, since I really don’t need things like the core files and contributed modules in the vendor folder to be persistent. So instead, it defines the pieces that are relevant to be able to build it, as well as the private and public folders where I might want to download a file for testing that the site can use.</p><p>I also have it set up to share my user profile’s SSH keys and preferred settings like the my commit name, so that I can connect to the repository without having to configure it all again with every new build.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.9"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">web"</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">web"</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s2">"</span><span class="s">.devcontainer"</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s2">"</span><span class="s">web.Dockerfile"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./.devcontainer/:/opt/drupal/.devcontainer/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./.git/:/opt/drupal/.git/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./.gitignore:/opt/drupal/.gitignore"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./.vscode/:/opt/drupal/.vscode/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./patches/:/opt/drupal/patches/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./private/:/opt/drupal/private/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./sync/:/opt/drupal/sync/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./web/sites/default/files/:/opt/drupal/web/sites/default/files/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./composer.json:/opt/drupal/composer.json"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./composer.lock:/opt/drupal/composer.lock"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./docker-compose.yml:/opt/drupal/docker-compose.yml"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./README.md:/opt/drupal/README.md"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">${USERPROFILE}/.ssh/:/user/www-data/.ssh/"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">${USERPROFILE}/.gitconfig:/user/www-data/.gitconfig"</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">www-data:www-data"</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">drupal"</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db"</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db"</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s2">"</span><span class="s">.devcontainer"</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db.Dockerfile"</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">drupal"</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">drupal</span><span class="pi">:</span>
</pre></table></code></div></div><h2 id="next-post">Next Post<a href="#next-post" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>In the next post, I’ll mention some of the changes to the devcontainer.json file and to the postCreateCommand script, although there’s nothing too drastic there.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/websites/'>Websites</a>, <a href='/categories/drupal/'>Drupal</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/drupal-docker/" class="post-tag no-text-decoration" >Drupal Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Drupal Dev Environment Updated: The Dockerfiles - Ryan Robinson Technology&url=https://ryanrobinson.technology/websites/drupal/dev-env-updated/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Drupal Dev Environment Updated: The Dockerfiles - Ryan Robinson Technology&u=https://ryanrobinson.technology/websites/drupal/dev-env-updated/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Drupal Dev Environment Updated: The Dockerfiles - Ryan Robinson Technology&url=https://ryanrobinson.technology/websites/drupal/dev-env-updated/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ryanrobinson.technology/websites/drupal/dev-env-updated/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/websites/drupal/dev-env-updated/">Drupal Dev Environment Updated: The Dockerfiles</a><li><a href="/websites/drupal/open-menu/">Drupal: Open Menu</a><li><a href="/websites/vs-code/extensions-2024/">VS Code Extensions: My Workflows</a><li><a href="/websites/drupal/disable-pw-reset/">Drupal: Disable Password Reset</a><li><a href="/websites/brandwood-a11y/">Brandwood A11y Checker</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/visual-studio-code/">Visual Studio Code</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/gitlab/">GitLab</a> <a class="post-tag" href="/tags/accessibility/">Accessibility</a> <a class="post-tag" href="/tags/ms-101/">MS-101</a> <a class="post-tag" href="/tags/gitlab-devops/">GitLab DevOps</a> <a class="post-tag" href="/tags/ms-700/">MS-700</a> <a class="post-tag" href="/tags/drupal-docker/">Drupal Docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/websites/drupal/drupal-docker-devcontainer/"><div class="card-body"> <em class="timeago small" date="2022-03-18 08:38:00 -0400" >Mar 18, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Drupal Docker: devcontainer</h3><div class="text-muted small"><p> I have previously shared setting up local development environments using vagrant and GitPod in Drupal friendly ways. This post will start a new mini-series on how I built a Docker Desktop setup for...</p></div></div></a></div><div class="card"> <a href="/websites/drupal/dockerfiles/"><div class="card-body"> <em class="timeago small" date="2022-06-23 21:46:00 -0400" >Jun 23, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Drupal Docker: The Dockerfiles</h3><div class="text-muted small"><p> This continues a mini-series describing how I set up a Drupal development environment using Docker Desktop and the VS Code devcontainer functionality. The full code is available in my GitHub. This...</p></div></div></a></div><div class="card"> <a href="/websites/drupal/docker-config-script/"><div class="card-body"> <em class="timeago small" date="2022-06-28 21:46:00 -0400" >Jun 28, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Drupal Docker: The First-Run Script</h3><div class="text-muted small"><p> This continues a mini-series describing how I set up a Drupal development environment using Docker Desktop and the VS Code devcontainer functionality. The full code is available in my GitHub. This...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/websites/drupal/open-menu/" class="btn btn-outline-primary" prompt="Older"><p>Drupal: Open Menu</p></a> <a href="/websites/drupal/dev-env-updated-devcontainer/" class="btn btn-outline-primary" prompt="Newer"><p>Drupal Dev Environment Updated: The DevContainer</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://www.linkedin.com/in/ryanlewisrobinson/">Ryan Robinson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/visual-studio-code/">Visual Studio Code</a> <a class="post-tag" href="/tags/security/">Security</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/gitlab/">GitLab</a> <a class="post-tag" href="/tags/accessibility/">Accessibility</a> <a class="post-tag" href="/tags/ms-101/">MS-101</a> <a class="post-tag" href="/tags/gitlab-devops/">GitLab DevOps</a> <a class="post-tag" href="/tags/ms-700/">MS-700</a> <a class="post-tag" href="/tags/drupal-docker/">Drupal Docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
